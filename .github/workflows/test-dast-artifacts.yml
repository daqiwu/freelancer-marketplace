name: Test DAST Artifact Upload

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - bala
      - test-dast-artifacts
    paths:
      - ".github/workflows/test-dast-artifacts.yml"

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  test-dast-reports:
    name: ðŸ§ª Test DAST Report Generation & Upload
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display Environment Info
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              DAST ARTIFACT UPLOAD TEST                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“ GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "ðŸ“ PWD: $(pwd)"
          echo "ðŸ“ Runner workspace: $RUNNER_WORKSPACE"
          echo ""
      
      - name: Create Test Reports Directory
        run: |
          echo "ðŸ“ Creating zap-reports directory..."
          mkdir -p "$GITHUB_WORKSPACE/zap-reports"
          echo "âœ… Directory created at: $GITHUB_WORKSPACE/zap-reports"
          ls -la "$GITHUB_WORKSPACE" | grep zap
      
      - name: Run OWASP ZAP Full Scan
        run: |
          echo "ðŸ”Ž Starting ZAP full scan..."
          echo "ðŸ“ Reports will be saved to: $GITHUB_WORKSPACE/zap-reports/"
          echo ""
          
          set -x  # Enable command echo for debugging
          
          docker run -v "$GITHUB_WORKSPACE":/zap/wrk/:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t https://u7tnmpvsm8.ap-southeast-1.awsapprunner.com \
            -r /zap/wrk/zap-reports/report.html \
            -J /zap/wrk/zap-reports/report.json \
            -w /zap/wrk/zap-reports/report.md || true
          
          set +x  # Disable command echo
          echo ""
          echo "ðŸ”š ZAP scan finished"
        continue-on-error: true
      
      - name: Verify Reports Were Generated
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ðŸ“Š REPORT VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Check if directory exists
          if [ -d "$GITHUB_WORKSPACE/zap-reports" ]; then
            echo "âœ… zap-reports directory EXISTS"
            echo ""
            echo "ðŸ“ Directory contents:"
            ls -lah "$GITHUB_WORKSPACE/zap-reports"
            echo ""
            
            # Check each report file
            if [ -f "$GITHUB_WORKSPACE/zap-reports/report.html" ]; then
              HTML_SIZE=$(du -h "$GITHUB_WORKSPACE/zap-reports/report.html" | cut -f1)
              echo "âœ… report.html EXISTS (Size: $HTML_SIZE)"
            else
              echo "âŒ report.html NOT FOUND"
            fi
            
            if [ -f "$GITHUB_WORKSPACE/zap-reports/report.json" ]; then
              JSON_SIZE=$(du -h "$GITHUB_WORKSPACE/zap-reports/report.json" | cut -f1)
              echo "âœ… report.json EXISTS (Size: $JSON_SIZE)"
            else
              echo "âŒ report.json NOT FOUND"
            fi
            
            if [ -f "$GITHUB_WORKSPACE/zap-reports/report.md" ]; then
              MD_SIZE=$(du -h "$GITHUB_WORKSPACE/zap-reports/report.md" | cut -f1)
              echo "âœ… report.md EXISTS (Size: $MD_SIZE)"
            else
              echo "âŒ report.md NOT FOUND"
            fi
            
          else
            echo "âŒ zap-reports directory NOT FOUND at $GITHUB_WORKSPACE/zap-reports"
          fi
          echo ""
          
          # Show workspace root contents
          echo "ðŸ“‚ Workspace root contents:"
          ls -lah "$GITHUB_WORKSPACE" | head -n 30
      
      - name: Display Sample Report Content
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ðŸ“„ SAMPLE REPORT CONTENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ -f "$GITHUB_WORKSPACE/zap-reports/report.html" ]; then
            echo "ðŸ“„ First 50 lines of report.html:"
            echo "---"
            head -n 50 "$GITHUB_WORKSPACE/zap-reports/report.html"
            echo "---"
          fi
          echo ""
          
          if [ -f "$GITHUB_WORKSPACE/zap-reports/report.json" ]; then
            echo "ðŸ“„ First 30 lines of report.json:"
            echo "---"
            head -n 30 "$GITHUB_WORKSPACE/zap-reports/report.json"
            echo "---"
          fi
      
      - name: Test Artifact Upload (Method 1 - Relative Path)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-zap-reports-relative
          path: zap-reports/**
          retention-days: 7
          if-no-files-found: warn
      
      - name: Test Artifact Upload (Method 2 - Absolute Path)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-zap-reports-absolute
          path: ${{ github.workspace }}/zap-reports/**
          retention-days: 7
          if-no-files-found: warn
      
      - name: Test Artifact Upload (Method 3 - Individual Files)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-zap-reports-individual
          path: |
            zap-reports/report.html
            zap-reports/report.json
            zap-reports/report.md
          retention-days: 7
          if-no-files-found: warn
      
      - name: Generate Test Summary
        if: always()
        run: |
          {
            echo "# ðŸ§ª DAST Artifact Upload Test Results"
            echo ""
            echo "## ðŸ“Š Test Overview"
            echo ""
            echo "This workflow tests whether OWASP ZAP DAST reports are:"
            echo "1. âœ… Generated successfully by the ZAP Docker container"
            echo "2. âœ… Saved to the correct directory (\`\$GITHUB_WORKSPACE/zap-reports/\`)"
            echo "3. âœ… Uploaded as GitHub Actions artifacts"
            echo ""
            
            # Check if reports exist
            HTML_EXISTS="âŒ"
            JSON_EXISTS="âŒ"
            MD_EXISTS="âŒ"
            
            if [ -f "$GITHUB_WORKSPACE/zap-reports/report.html" ]; then
              HTML_EXISTS="âœ…"
              HTML_SIZE=$(du -h "$GITHUB_WORKSPACE/zap-reports/report.html" | cut -f1)
            else
              HTML_SIZE="N/A"
            fi
            
            if [ -f "$GITHUB_WORKSPACE/zap-reports/report.json" ]; then
              JSON_EXISTS="âœ…"
              JSON_SIZE=$(du -h "$GITHUB_WORKSPACE/zap-reports/report.json" | cut -f1)
            else
              JSON_SIZE="N/A"
            fi
            
            if [ -f "$GITHUB_WORKSPACE/zap-reports/report.md" ]; then
              MD_EXISTS="âœ…"
              MD_SIZE=$(du -h "$GITHUB_WORKSPACE/zap-reports/report.md" | cut -f1)
            else
              MD_SIZE="N/A"
            fi
            
            echo "## ðŸ“ Report Generation Status"
            echo ""
            echo "| Report File | Status | Size |"
            echo "|-------------|--------|------|"
            echo "| report.html | ${HTML_EXISTS} | ${HTML_SIZE} |"
            echo "| report.json | ${JSON_EXISTS} | ${JSON_SIZE} |"
            echo "| report.md | ${MD_EXISTS} | ${MD_SIZE} |"
            echo ""
            
            echo "## ðŸ“¦ Artifact Upload Methods Tested"
            echo ""
            echo "Three different upload methods were tested:"
            echo ""
            echo "1. **Relative Path** (\`zap-reports/**\`)"
            echo "   - Artifact name: \`test-zap-reports-relative\`"
            echo ""
            echo "2. **Absolute Path** (\`\${{ github.workspace }}/zap-reports/**\`)"
            echo "   - Artifact name: \`test-zap-reports-absolute\`"
            echo ""
            echo "3. **Individual Files** (explicit file list)"
            echo "   - Artifact name: \`test-zap-reports-individual\`"
            echo ""
            
            echo "## ðŸ” How to Verify"
            echo ""
            echo "1. Check the **Artifacts** section at the bottom of this workflow run"
            echo "2. Download each artifact to verify contents"
            echo "3. Compare which method worked best"
            echo ""
            
            echo "## ðŸŽ¯ Target Application"
            echo ""
            echo "- **URL**: \`https://u7tnmpvsm8.ap-southeast-1.awsapprunner.com\`"
            echo "- **Scan Type**: OWASP ZAP Full Scan"
            echo "- **Tool Version**: \`ghcr.io/zaproxy/zaproxy:stable\`"
            echo ""
            
            echo "---"
            echo ""
            echo "### âœ… Test Recommendations"
            echo ""
            if [ "$HTML_EXISTS" = "âœ…" ] && [ "$JSON_EXISTS" = "âœ…" ]; then
              echo "**Status**: ðŸŽ‰ All reports generated successfully!"
              echo ""
              echo "The current DAST configuration in \`backend-ci-complete.yml\` is working correctly."
            else
              echo "**Status**: âš ï¸ Some reports are missing!"
              echo ""
              echo "**Troubleshooting steps**:"
              echo "1. Check the ZAP scan logs in the workflow output"
              echo "2. Verify the Docker volume mount is correct"
              echo "3. Ensure the target URL is accessible"
              echo "4. Check ZAP container permissions"
            fi
          } >> $GITHUB_STEP_SUMMARY
