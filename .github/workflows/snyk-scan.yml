name: Snyk Scan

on:
  push:
    branches:
      - main
      - dev
      - bala
    paths:
      - "backend/**/*.py"
      - "backend/requirements.txt"
      - "backend/pytest.ini"
      - ".github/workflows/*"
  workflow_dispatch:

jobs:
  snyk-scan:
    name: ðŸ” Snyk Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Install Dependencies
        working-directory: backend
        run: poetry install

      - name: Install Snyk in Poetry Environment
        working-directory: backend
        run: |
          echo "ðŸ“¦ Installing Snyk CLI in Poetry virtual environment..."
          poetry run pip install snyk
          poetry run snyk --version
          echo "âœ… Snyk installed successfully!"

      - name: Authenticate Snyk
        working-directory: backend
        env:
          SNYK_TOKEN: dffc014b-e093-416d-9444-106a69d4b344
        run: |
          echo "ðŸ” Authenticating with Snyk..."
          poetry run snyk auth $SNYK_TOKEN
          echo "âœ… Snyk authentication successful!"

      - name: Run Snyk Test
        working-directory: backend
        env:
          SNYK_TOKEN: dffc014b-e093-416d-9444-106a69d4b344
        run: |
          echo "ðŸ” Running Snyk security test..."
          poetry run snyk test --file=poetry.lock --package-manager=poetry > snyk-report.txt || true
          echo "âœ… Snyk test completed!"
        continue-on-error: true

      - name: Upload to Snyk Dashboard
        working-directory: backend
        env:
          SNYK_TOKEN: dffc014b-e093-416d-9444-106a69d4b344
        run: |
          echo "ðŸ“Š Uploading results to Snyk dashboard..."
          poetry run snyk monitor --file=poetry.lock --package-manager=poetry
          echo "âœ… Results uploaded to Snyk dashboard!"

      - name: Upload Snyk Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-report
          path: backend/snyk-report.txt
          retention-days: 90
          if-no-files-found: warn
