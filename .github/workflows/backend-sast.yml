name: Backend SAST (AI Security Classification)

on:
  push:
    branches:
      - main
      - develop
      - gaorongrong
    paths:
      - "backend/**/*.py"

  pull_request:
    branches:
      - main
      - develop

  workflow_dispatch:

  # Run daily at 2 AM UTC
  schedule:
    - cron: "0 2 * * *"

jobs:
  sast-scan:
    name: Static Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install security scanning tools
        run: |
          pip install --upgrade pip
          pip install bandit==1.7.8 safety==3.0.0

      - name: Run Bandit (SAST)
        working-directory: backend
        run: |
          echo "Running Bandit Static Application Security Testing..."
          bandit -r . \
            --exclude '*/__pycache__/*,*/.venv/*,*/venv/*,*/htmlcov/*,*/.pytest_cache/*' \
            --format json \
            --output bandit-sast-report.json \
            --severity-level high \
            --confidence-level high || echo '{"results": [], "errors": []}' > bandit-sast-report.json
          # Ensure file exists
          if [ ! -f bandit-sast-report.json ]; then
            echo '{"results": [], "errors": []}' > bandit-sast-report.json
          fi
        continue-on-error: true

      - name: Run Safety (SCA - Dependency Check)
        working-directory: backend
        run: |
          echo "Running Safety Software Composition Analysis..."
          safety scan --json > safety-sca-report.json 2>&1 || echo '{"scan_results": [], "error": "No vulnerabilities or scan failed"}' > safety-sca-report.json
          # Ensure file exists
          if [ ! -f safety-sca-report.json ]; then
            echo '{"scan_results": [], "status": "no_file_generated"}' > safety-sca-report.json
          fi
        continue-on-error: true

      - name: Display SAST Summary
        if: always()
        working-directory: backend
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  SAST & SCA Security Scan Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“Š Bandit SAST Results:"
          bandit -r . \
            --exclude '*/__pycache__/*,*/.venv/*,*/venv/*,*/htmlcov/*,*/.pytest_cache/*' \
            --format screen \
            --severity-level high \
            --confidence-level high || true
          echo ""
          echo "ðŸ“Š Safety SCA Results:"
          safety check || true
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true

      - name: Verify Report Files
        if: always()
        working-directory: backend
        run: |
          echo "Checking for report files..."
          ls -la *.json || echo "No JSON files found"
          if [ -f bandit-sast-report.json ]; then
            echo "âœ“ Bandit report exists ($(stat -f%z bandit-sast-report.json 2>/dev/null || stat -c%s bandit-sast-report.json) bytes)"
          else
            echo "âœ— Bandit report missing"
          fi
          if [ -f safety-sca-report.json ]; then
            echo "âœ“ Safety report exists ($(stat -f%z safety-sca-report.json 2>/dev/null || stat -c%s safety-sca-report.json) bytes)"
          else
            echo "âœ— Safety report missing"
          fi

      - name: Upload SAST Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: backend/bandit-sast-report.json
          retention-days: 90

      - name: Upload SCA Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-report
          path: backend/safety-sca-report.json
          retention-days: 90

      - name: Security Summary
        if: always()
        working-directory: backend
        run: |
          echo "âœ… Security scans completed!"
          echo ""
          echo "This workflow demonstrates AI-powered security classification:"
          echo "  â€¢ SAST (Static Application Security Testing) - Bandit"
          echo "  â€¢ SCA (Software Composition Analysis) - Safety"
          echo "  â€¢ DAST would require runtime testing in a deployed environment"
          echo ""
          echo "Check artifacts for detailed JSON reports that can be"
          echo "analyzed by the AI Security Classifier API endpoint."
