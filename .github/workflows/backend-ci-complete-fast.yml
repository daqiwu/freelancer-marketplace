name: Backend CI/CD - Fast Parallel Pipeline

on:
  push:
    branches:
      - main
      - develop
      - gaorongrong
      - bala
    paths:
      - "backend/**/*.py"
      - "backend/requirements.txt"
      - "backend/pytest.ini"
      - ".github/workflows/backend-ci-complete-fast.yml"

  workflow_dispatch: # Allow manual trigger

  # Run daily at 2 AM UTC
  schedule:
    - cron: "0 2 * * *"

permissions:
  id-token: write
  contents: read
  security-events: write
  issues: write

env:
  AWS_REGION: ap-southeast-1
  ACCOUNT_ID: 539827877726
  ECR_PUBLIC_URI: t7x9p0n7/freelancermarketplace
  DOCKER_IMAGE_NAME: balachander20/freelancer-marketplace-api
  PYTHON_VERSION: "3.12"

jobs:
  # ============================================
  # Job 1: Parallel Quality & Security Checks
  # Uses matrix to run all checks in parallel
  # ============================================
  quality-and-security-matrix:
    name: ğŸ” ${{ matrix.check.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue other checks even if one fails
      matrix:
        check:
          - name: "Linting & Formatting"
            type: "lint"
          - name: "SAST Security Scan"
            type: "sast"
          - name: "SCA Vulnerability Scan"
            type: "sca"
          - name: "Snyk Security Scan"
            type: "snyk"
    
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # ============================================
      # LINTING
      # ============================================
      - name: Install Linting Tools
        if: matrix.check.type == 'lint'
        run: |
          pip install --upgrade pip
          pip install black isort flake8

      - name: Run Black Format Check
        if: matrix.check.type == 'lint'
        working-directory: backend
        run: black --check --line-length 200 .

      - name: Run isort Check
        if: matrix.check.type == 'lint'
        working-directory: backend
        run: isort --check-only --profile black .

      - name: Run Flake8
        if: matrix.check.type == 'lint'
        working-directory: backend
        run: flake8 .

      # ============================================
      # SAST
      # ============================================
      - name: Install Bandit
        if: matrix.check.type == 'sast'
        run: pip install bandit==1.7.8

      - name: Run Bandit SAST
        if: matrix.check.type == 'sast'
        working-directory: backend
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f sarif -o bandit-report.sarif || true
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        if: matrix.check.type == 'sast'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: backend/bandit-report.sarif
        continue-on-error: true

      - name: Upload SAST Reports
        if: matrix.check.type == 'sast' && always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: backend/bandit-report.*
          retention-days: 90

      # ============================================
      # SCA
      # ============================================
      - name: Install pip-audit
        if: matrix.check.type == 'sca'
        run: pip install pip-audit

      - name: Install Poetry
        if: matrix.check.type == 'sca'
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Install Dependencies
        if: matrix.check.type == 'sca'
        working-directory: backend
        run: poetry install

      - name: Run pip-audit
        if: matrix.check.type == 'sca'
        working-directory: backend
        run: |
          pip-audit --format json --output pip-audit-report.json || echo '{"vulnerabilities": []}' > pip-audit-report.json
        continue-on-error: true

      - name: Upload SCA Report
        if: matrix.check.type == 'sca' && always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-reports
          path: backend/pip-audit-report.json
          retention-days: 90

      # ============================================
      # SNYK
      # ============================================
      - name: Install Poetry for Snyk
        if: matrix.check.type == 'snyk'
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Install Dependencies for Snyk
        if: matrix.check.type == 'snyk'
        working-directory: backend
        run: poetry install

      - name: Install Snyk CLI
        if: matrix.check.type == 'snyk'
        run: |
          npm install -g snyk
          snyk --version

      - name: Authenticate Snyk
        if: matrix.check.type == 'snyk'
        env:
          SNYK_TOKEN: dffc014b-e093-416d-9444-106a69d4b344
        run: snyk auth $SNYK_TOKEN

      - name: Run Snyk Test
        if: matrix.check.type == 'snyk'
        working-directory: backend
        env:
          SNYK_TOKEN: dffc014b-e093-416d-9444-106a69d4b344
        run: |
          snyk test --file=poetry.lock --package-manager=poetry --json > snyk-report.json || true
          snyk monitor --file=poetry.lock --package-manager=poetry || true
        continue-on-error: true

      - name: Upload Snyk Reports
        if: matrix.check.type == 'snyk' && always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-reports
          path: backend/snyk-report.json
          retention-days: 90

  # ============================================
  # Job 2: Unit Tests (Runs in parallel with security checks)
  # ============================================
  unit-tests:
    name: ğŸ§ª Unit Tests & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Install Dependencies
        working-directory: backend
        run: poetry install

      - name: Run Tests with Coverage
        working-directory: backend
        run: |
          poetry run pytest \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            -v

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            backend/coverage.xml
            backend/htmlcov/
          retention-days: 90

  # ============================================
  # Job 3: Docker Build and Push
  # Waits only for unit tests (not security scans)
  # ============================================
  build-and-push:
    name: ğŸ³ Build and Push to ECR Public
    runs-on: ubuntu-latest
    needs: [unit-tests]  # Only needs unit tests to pass
    if: github.event_name == 'push'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/github-actions-role

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      - name: Build Docker Image
        working-directory: backend
        run: |
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:latest .

      - name: Tag Docker Image for ECR Public
        run: |
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest public.ecr.aws/${{ env.ECR_PUBLIC_URI }}:latest
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest public.ecr.aws/${{ env.ECR_PUBLIC_URI }}:${{ github.sha }}

      - name: Push Docker Image to ECR Public
        run: |
          docker push public.ecr.aws/${{ env.ECR_PUBLIC_URI }}:latest
          docker push public.ecr.aws/${{ env.ECR_PUBLIC_URI }}:${{ github.sha }}

  # ============================================
  # Job 4: DAST Security Scan
  # Runs after Docker image is pushed
  # ============================================
  dast-scan:
    name: ğŸŒ DAST Security Scan
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always()  # Run even if build fails (uses existing deployment)
    
    permissions:
      issues: write
      security-events: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run OWASP ZAP Full Scan
        run: |
          mkdir -p zap-reports
          docker run -v $(pwd):/zap/wrk/:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t https://u7tnmpvsm8.ap-southeast-1.awsapprunner.com \
            -r /zap/wrk/zap-reports/report.html \
            -J /zap/wrk/zap-reports/report.json \
            -w /zap/wrk/zap-reports/report.md || true
        continue-on-error: true
      
      - name: Upload DAST Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: zap-reports/
          retention-days: 90

  # ============================================
  # Job 5: Pipeline Summary
  # ============================================
  pipeline-summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [quality-and-security-matrix, unit-tests, build-and-push, dast-scan]
    if: always()

    steps:
      - name: Pipeline Results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Backend CI/CD Fast Parallel Pipeline Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Parallel Quality & Security Checks:"
          echo "  ğŸ” Matrix Jobs:                   ${{ needs.quality-and-security-matrix.result }}"
          echo ""
          echo "Testing:"
          echo "  ğŸ§ª Unit Tests & Coverage:         ${{ needs.unit-tests.result }}"
          echo ""
          echo "Build & Deploy:"
          echo "  ğŸ³ Docker Build & Push:           ${{ needs.build-and-push.result }}"
          echo ""
          echo "Runtime Security:"
          echo "  ğŸŒ DAST (ZAP Security Scan):      ${{ needs.dast-scan.result }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ Artifacts Generated:"
          echo "  â€¢ Coverage reports (XML & HTML)"
          echo "  â€¢ SAST reports (Bandit JSON & SARIF)"
          echo "  â€¢ SCA reports (pip-audit JSON)"
          echo "  â€¢ Snyk reports (JSON)"
          echo "  â€¢ DAST reports (ZAP HTML, JSON, MD)"
          echo ""
          echo "âš¡ Pipeline optimized with parallel matrix execution!"
          echo "âœ… Pipeline execution completed!"
